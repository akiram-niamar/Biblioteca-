<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestione Biblioteca Infanzia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p: #4f46e5; --s: #10b981; --d: #ef4444; --bg: #f8fafc; }
        * { box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); margin: 0; padding-bottom: 50px; color: #1e293b; }
        .header { background: var(--p); color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; }
        .container { max-width: 500px; margin: auto; padding: 10px; }
        
        /* Navigazione */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: white; padding: 5px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; border: none; padding: 12px 5px; background: none; cursor: pointer; border-radius: 8px; font-size: 0.75rem; font-weight: bold; color: #64748b; }
        .tab-btn.active { background: var(--p); color: white; }

        /* Card */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h3 { margin: 0 0 15px 0; font-size: 1rem; color: var(--p); border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        
        /* Form */
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; color: white; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-p { background: var(--p); }
        .btn-s { background: var(--s); }
        .btn-d { background: #f1f5f9; color: #64748b; font-size: 0.8rem; }

        /* Liste */
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .item:last-child { border: none; }
        .item-info h4 { margin: 0; font-size: 0.9rem; }
        .item-info p { margin: 2px 0 0 0; font-size: 0.75rem; color: #64748b; }
        .badge { font-size: 0.7rem; padding: 3px 7px; border-radius: 5px; font-weight: bold; }
        .badge-ok { background: #dcfce7; color: #166534; }
        .badge-out { background: #fee2e2; color: #991b1b; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header">ðŸ“š La Mia Biblioteca</div>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('pre')">PRESTITO</button>
        <button class="tab-btn" onclick="showTab('res')">RESI</button>
        <button class="tab-btn" onclick="showTab('cat')">CATALOGO</button>
        <button class="tab-btn" onclick="showTab('adm')">GESTIONE</button>
    </div>

    <div id="t-pre" class="card">
        <h3>Nuovo Prestito</h3>
        <label>Bambino</label>
        <select id="loan-kid"><option value="">Carica i nomi in Gestione...</option></select>
        <label>Libro (Scansiona o scrivi Titolo)</label>
        <input type="text" id="loan-book" placeholder="Cerca libro...">
        <button class="btn btn-p" onclick="handleLoan()">REGISTRA PRESTITO</button>
    </div>

    <div id="t-res" class="card hidden">
        <h3>Libri da Rientrare</h3>
        <div id="list-res"></div>
    </div>

    <div id="t-cat" class="card hidden">
        <input type="text" id="search-cat" placeholder="Cerca nel catalogo..." onkeyup="refreshUI()">
        <div id="list-cat" style="margin-top:10px"></div>
    </div>

    <div id="t-adm" class="card hidden">
        <h3>Aggiungi Libro</h3>
        <input type="text" id="add-id" placeholder="Codice/ISBN (opzionale)">
        <input type="text" id="add-title" placeholder="Titolo del libro">
        <button class="btn btn-s" onclick="addBook()">AGGIUNGI LIBRO</button>

        <h3 style="margin-top:20px">Aggiungi Bambino</h3>
        <div style="display:flex; gap:5px">
            <input type="text" id="add-kid" placeholder="Nome bambino" style="margin:0">
            <button class="btn btn-p" style="width:70px" onclick="addKid()">OK</button>
        </div>

        <h3 style="margin-top:20px">Importa Excel</h3>
        <input type="file" id="file-excel" accept=".xlsx, .xls">
        <button class="btn btn-d" onclick="importExcel()">CARICA FILE EXCEL</button>

        <button class="btn btn-d" style="margin-top:30px; color:red" onclick="clearData()">RESET TOTALE</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('biblio_db')) || { books: [], kids: [] };

    function save() {
        localStorage.setItem('biblio_db', JSON.stringify(db));
        refreshUI();
    }

    function showTab(t) {
        document.querySelectorAll('[id^="t-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('t-' + t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        refreshUI();
    }

    function addKid() {
        const name = document.getElementById('add-kid').value.trim();
        if(name) {
            db.kids.push(name);
            document.getElementById('add-kid').value = '';
            save();
        }
    }

    function addBook() {
        const title = document.getElementById('add-title').value.trim();
        const code = document.getElementById('add-id').value.trim() || 'MAN-' + Date.now();
        if(!title) return alert("Inserisci il titolo");
        db.books.push({ id: code, title: title, status: 'disponibile', kid: '', date: '' });
        document.getElementById('add-title').value = '';
        document.getElementById('add-id').value = '';
        save();
        alert("Libro salvato!");
    }

    function importExcel() {
        const file = document.getElementById('file-excel').files[0];
        if(!file) return alert("Scegli un file");
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            raw.forEach(r => {
                const t = r.Title || r.Titolo || r.title || "Senza Titolo";
                const i = r.ISBN || r.Barcode || r.ID || 'EX-' + Math.random();
                db.books.push({ id: String(i), title: t, status: 'disponibile', kid: '', date: '' });
            });
            save();
            alert("Importati " + raw.length + " libri!");
        };
        reader.readAsArrayBuffer(file);
    }

    function handleLoan() {
        const kid = document.getElementById('loan-kid').value;
        const search = document.getElementById('loan-book').value.toLowerCase().trim();
        if(!kid || !search) return alert("Seleziona bambino e cerca libro");

        const book = db.books.find(b => b.status === 'disponibile' && 
            (b.title.toLowerCase().includes(search) || b.id.toLowerCase() === search));

        if(book) {
            book.status = 'prestito';
            book.kid = kid;
            book.date = new Date().toLocaleDateString('it-IT');
            document.getElementById('loan-book').value = '';
            save();
            alert("Prestito registrato!");
        } else {
            alert("Libro non trovato o giÃ  in prestito");
        }
    }

    function handleReturn(bookId) {
        // Cerchiamo il libro esatto per ID
        const book = db.books.find(b => b.id === bookId);
        if(book) {
            book.status = 'disponibile';
            book.kid = '';
            book.date = '';
            save(); // Salva e aggiorna i tab
        }
    }

    function refreshUI() {
        // Aggiorna Select Bambini
        const sel = document.getElementById('loan-kid');
        const current = sel.value;
        sel.innerHTML = '<option value="">-- Chi prende il libro? --</option>' + 
            db.kids.sort().map(k => `<option value="${k}" ${k==current?'selected':''}>${k}</option>`).join('');

        // Aggiorna Lista Resi
        const resDiv = document.getElementById('list-res');
        const inLoan = db.books.filter(b => b.status === 'prestito');
        resDiv.innerHTML = inLoan.map(b => `
            <div class="item">
                <div class="item-info"><h4>${b.title}</h4><p>A: ${b.kid} (${b.date})</p></div>
                <button class="btn btn-s" style="width:auto; padding:5px 10px" onclick="handleReturn('${b.id}')">RESO</button>
            </div>
        `).join('') || '<p style="text-align:center;color:#999">Tutti i libri sono in sede.</p>';

        // Aggiorna Catalogo
        const query = document.getElementById('search-cat').value.toLowerCase();
        const catDiv = document.getElementById('list-cat');
        catDiv.innerHTML = db.books
            .filter(b => b.title.toLowerCase().includes(query) || b.id.toLowerCase().includes(query))
            .map(b => `
            <div class="item">
                <div class="item-info"><h4>${b.title}</h4><p>ID: ${b.id}</p></div>
                <span class="badge ${b.status=='disponibile'?'badge-ok':'badge-out'}">
                    ${b.status=='disponibile'?'Disponibile':'In Prestito'}
                </span>
            </div>
        `).join('');
    }

    function clearData() {
        if(confirm("Vuoi cancellare tutto?")) {
            db = { books: [], kids: [] };
            save();
        }
    }

    refreshUI();
</script>
</body>
</html>
