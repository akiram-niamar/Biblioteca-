<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BiblioScuola</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:system-ui;background:#f4f7f6;margin:0}
.header{background:#5a67d8;color:white;padding:15px;text-align:center}
.container{max-width:700px;margin:auto;padding:15px}
.card{background:white;padding:15px;border-radius:12px;margin-bottom:15px}
h3{color:#5a67d8}
input,select,button{width:100%;padding:10px;margin:5px 0}
button{background:#5a67d8;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
button.danger{background:#e53e3e}
button.small{width:auto;padding:5px 10px;font-size:12px}
.list{border-top:1px solid #eee;margin-top:10px}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
.badge{padding:3px 8px;border-radius:6px;font-size:12px}
.ok{background:#c6f6d5}
.out{background:#feebc8}
</style>
</head>

<body>
<div class="header"><h1>ğŸ“š BiblioScuola</h1></div>
<div class="container">

<div class="card">
<h3>â• Bambini</h3>
<input id="kid-name" placeholder="Nome bambino">
<button onclick="addKid()">Aggiungi</button>
<input type="file" id="kid-file" accept=".xlsx,.xls">
<button onclick="importKids()">Importa Bambini da Excel</button>
<button onclick="exportKids()">Esporta Bambini</button>
<div id="kids-list" class="list"></div>
</div>

<div class="card">
<h3>â• Libri</h3>
<input id="book-title" placeholder="Titolo">
<input id="book-author" placeholder="Autore">
<button onclick="addBook()">Aggiungi</button>
<input type="file" id="book-file" accept=".xlsx,.xls">
<button onclick="importBooks()">Importa Libri da Excel</button>
<button onclick="exportBooks()">Esporta Libri</button>
<div id="books-list" class="list"></div>
</div>

<div class="card">
<h3>ğŸ“– Prestito</h3>
<select id="sel-kid"></select>
<select id="sel-book"></select>
<button onclick="borrowBook()">Conferma Prestito</button>
</div>

<div class="card">
<h3>ğŸ” Resi</h3>
<div id="loaned-list"></div>
</div>

</div>

<script>
let kids = JSON.parse(localStorage.getItem("kids")) || [];
let books = JSON.parse(localStorage.getItem("books")) || [];

function save(){localStorage.setItem("kids",JSON.stringify(kids));localStorage.setItem("books",JSON.stringify(books));render();}

// ---------- BAMBINI ----------
function addKid(){
const n=document.getElementById("kid-name").value.trim();
if(!n||kids.includes(n))return;
kids.push(n);document.getElementById("kid-name").value="";save();
}

function deleteKid(name){
if(books.some(b=>b.loaned&&b.kid===name)){alert("Ha libri in prestito");return;}
kids=kids.filter(k=>k!==name);save();
}

function importKids(){
const f=document.getElementById("kid-file").files[0];if(!f)return;
const r=new FileReader();
r.onload=e=>{
const wb=XLSX.read(e.target.result,{type:"array"});
const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
data.forEach(r=>{const n=r.Nome||r.Name;if(n&&!kids.includes(n))kids.push(n)});
save();
};
r.readAsArrayBuffer(f);
}

function exportKids(){
const ws=XLSX.utils.aoa_to_sheet([["Nome"],...kids.map(k=>[k])]);
const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Bambini");
XLSX.writeFile(wb,"bambini.xlsx");
}

// ---------- LIBRI ----------
function addBook(){
const t=document.getElementById("book-title").value.trim();
if(!t)return;
books.push({id:Date.now()+Math.random(),title:t,author:book-author.value||"",loaned:false,kid:"",date:""});
book-title.value="";book-author.value="";save();
}

function deleteBook(id){
if(books.find(b=>b.id===id).loaned){alert("Libro in prestito");return;}
books=books.filter(b=>b.id!==id);save();
}

function importBooks(){
const f=document.getElementById("book-file").files[0];if(!f)return;
const r=new FileReader();
r.onload=e=>{
const wb=XLSX.read(e.target.result,{type:"array"});
const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
data.forEach(r=>{
books.push({id:Date.now()+Math.random(),title:r.Titolo||r.Title||"",author:r.Autore||"",loaned:false,kid:"",date:""});
});
save();
};
r.readAsArrayBuffer(f);
}

function exportBooks(){
const ws=XLSX.utils.json_to_sheet(books);
const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Libri");
XLSX.writeFile(wb,"libri.xlsx");
}

// ---------- PRESTITI ----------
function borrowBook(){
const k=sel-kid.value,b=sel-book.value;
if(!k||!b)return;
const book=books.find(x=>x.id==b);
book.loaned=true;book.kid=k;book.date=new Date().toLocaleDateString("it-IT");
save();
}

function returnBook(id){
const b=books.find(x=>x.id===id);
b.loaned=false;b.kid="";b.date="";save();
}

// ---------- RENDER ----------
function render(){
kids-list.innerHTML=kids.map(k=>`<div class="item">${k}<button class="small danger" onclick="deleteKid('${k}')">âœ•</button></div>`).join("");
books-list.innerHTML=books.map(b=>`<div class="item">${b.title}<button class="small danger" onclick="deleteBook(${b.id})">âœ•</button></div>`).join("");
sel-kid.innerHTML='<option></option>'+kids.map(k=>`<option>${k}</option>`).join("");
sel-book.innerHTML='<option></option>'+books.filter(b=>!b.loaned).map(b=>`<option value="${b.id}">${b.title}</option>`).join("");
loaned-list.innerHTML=books.filter(b=>b.loaned).map(b=>`<div class="item">${b.title} â†’ ${b.kid}<button class="small" onclick="returnBook(${b.id})">RESO</button></div>`).join("");
}
render();
</script>
</body>
        </html>
