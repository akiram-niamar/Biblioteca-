<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BiblioScuola PRO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* === GRAFICA ORIGINALE NON TOCCATA === */
:root { --primary:#5a67d8;--secondary:#764ba2;--bg:#f4f7f6;--success:#48bb78;--danger:#e53e3e; }
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:var(--bg);color:#2d3748}
.header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:20px;text-align:center}
.container{padding:15px;max-width:600px;margin:auto}
.stats{display:flex;gap:10px;margin:-15px 0 20px}
.stat-card{flex:1;background:white;padding:12px;border-radius:12px;text-align:center}
.stat-num{font-size:1.2rem;font-weight:bold;color:var(--primary)}
.stat-label{font-size:.6rem;color:#718096;text-transform:uppercase}
.nav{display:flex;background:white;border-radius:12px;overflow:hidden;margin-bottom:20px}
.nav-btn{flex:1;border:none;padding:15px 5px;background:none;font-weight:bold;font-size:.75rem;color:#718096;cursor:pointer}
.nav-btn.active{color:var(--primary);border-bottom:3px solid var(--primary)}
.card{background:white;padding:20px;border-radius:16px;margin-bottom:20px}
h3{margin-bottom:15px;color:var(--primary)}
input,select{width:100%;padding:12px;margin-bottom:15px;border:1px solid #e2e8f0;border-radius:10px}
.btn{width:100%;padding:14px;border:none;border-radius:10px;background:var(--primary);color:white;font-weight:bold}
.btn-success{background:var(--success)}
.btn-res{padding:6px 12px;font-size:.75rem;background:var(--success)}
.hidden{display:none}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #edf2f7}
.info h4{font-size:.9rem}
.info p{font-size:.75rem;color:#718096}
.badge{font-size:.7rem;padding:4px 8px;border-radius:6px;font-weight:bold}
.bg-ok{background:#c6f6d5;color:#22543d}
.bg-out{background:#feebc8;color:#744210}
.tag{display:inline-block;background:#edf2f7;padding:4px 10px;border-radius:15px;font-size:.75rem;margin:3px}
</style>
</head>

<body>
<div class="header"><h1>ðŸ“š BiblioScuola</h1></div>
<div class="container">

<div class="stats">
<div class="stat-card"><span id="s-tot" class="stat-num">0</span><span class="stat-label">Libri</span></div>
<div class="stat-card"><span id="s-pre" class="stat-num">0</span><span class="stat-label">Fuori</span></div>
<div class="stat-card"><span id="s-kids" class="stat-num">0</span><span class="stat-label">Bambini</span></div>
</div>

<div class="nav">
<button class="nav-btn active" id="n-pre" onclick="showTab('pre')">PRESTITO</button>
<button class="nav-btn" id="n-res" onclick="showTab('res')">RESI</button>
<button class="nav-btn" id="n-cat" onclick="showTab('cat')">CATALOGO</button>
<button class="nav-btn" id="n-adm" onclick="showTab('adm')">GESTIONE</button>
</div>

<div id="tab-pre" class="card">
<h3>Registra Prestito</h3>
<select id="sel-kid"></select>
<select id="sel-book"></select>
<button class="btn" onclick="executeBorrow()">Conferma Prestito</button>
</div>

<div id="tab-res" class="card hidden">
<h3>Libri in Prestito</h3>
<div id="list-res"></div>
</div>

<div id="tab-cat" class="card hidden">
<input id="search-cat" placeholder="ðŸ” Cerca..." onkeyup="refreshUI()">
<div id="list-cat"></div>
</div>

<div id="tab-adm" class="card hidden">

<h3>âž• Aggiungi Libro</h3>
<input id="new-id" placeholder="ID">
<input id="new-title" placeholder="Titolo">
<input id="new-auth" placeholder="Autore">
<button class="btn btn-success" onclick="addBook()">Salva Libro</button>

<button class="btn" style="margin-top:10px" onclick="exportBooks()">ðŸ“¤ Esporta Libri</button>

<h3 style="margin-top:25px">ðŸ‘¶ Aggiungi Bambino</h3>
<div style="display:flex;gap:5px">
<input id="new-kid" placeholder="Nome Bambino" style="margin:0">
<button class="btn" style="width:70px" onclick="addKid()">OK</button>
</div>

<input type="file" id="kid-file" accept=".xlsx,.xls">
<button class="btn" onclick="importKids()">ðŸ“¥ Importa Bambini</button>
<button class="btn" onclick="exportKids()">ðŸ“¤ Esporta Bambini</button>

<div id="kids-display" style="margin-top:10px"></div>

<button class="btn" style="margin-top:30px;background:var(--danger)" onclick="clearDB()">Svuota Tutto</button>
</div>

</div>

<script>
let db_books=JSON.parse(localStorage.getItem("lib_books"))||[];
let db_kids=JSON.parse(localStorage.getItem("lib_kids"))||[];

function sync(){
localStorage.setItem("lib_books",JSON.stringify(db_books));
localStorage.setItem("lib_kids",JSON.stringify(db_kids));
refreshUI();
}

function showTab(t){
document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
document.getElementById("tab-"+t).classList.remove("hidden");
document.getElementById("n-"+t).classList.add("active");
refreshUI();
}

/* ===== BAMBINI ===== */
function addKid(){
const n=document.getElementById("new-kid").value.trim();
if(n&&!db_kids.includes(n)){db_kids.push(n);document.getElementById("new-kid").value="";sync();}
}

function deleteKid(name){
if(db_books.some(b=>b.loaned&&b.kid===name)){alert("Ha libri in prestito");return;}
db_kids=db_kids.filter(k=>k!==name);sync();
}

function importKids(){
const f=document.getElementById("kid-file").files[0];if(!f)return;
const r=new FileReader();
r.onload=e=>{
const wb=XLSX.read(e.target.result,{type:"array"});
const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
data.forEach(r=>{const n=r.Nome||r.Name;if(n&&!db_kids.includes(n))db_kids.push(n);});
sync();
};
r.readAsArrayBuffer(f);
}

function exportKids(){
const ws=XLSX.utils.aoa_to_sheet([["Nome"],...db_kids.map(k=>[k])]);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Bambini");
XLSX.writeFile(wb,"bambini.xlsx");
}

/* ===== LIBRI ===== */
function addBook(){
const t=document.getElementById("new-title").value.trim();
if(!t)return;
db_books.push({id:document.getElementById("new-id").value||Date.now(),title:t,author:document.getElementById("new-auth").value||"",loaned:false,kid:"",date:""});
document.getElementById("new-id").value=document.getElementById("new-title").value=document.getElementById("new-auth").value="";
sync();
}

function exportBooks(){
const ws=XLSX.utils.json_to_sheet(db_books);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Libri");
XLSX.writeFile(wb,"libri.xlsx");
}

/* ===== PRESTITI ===== */
function executeBorrow(){
const kid=selKid.value,bookId=selBook.value;
if(!kid||!bookId)return;
const b=db_books.find(x=>x.id==bookId);
b.loaned=true;b.kid=kid;b.date=new Date().toLocaleDateString("it-IT");
sync();
}

function executeReturn(id){
const b=db_books.find(x=>x.id===id);
b.loaned=false;b.kid="";b.date="";
sync();
}

function clearDB(){
if(confirm("Cancellare tutto?")){db_books=[];db_kids=[];sync();}
}

/* ===== UI ===== */
function refreshUI(){
sTot.innerText=db_books.length;
sPre.innerText=db_books.filter(b=>b.loaned).length;
sKids.innerText=db_kids.length;

selKid.innerHTML='<option value="">Bambino</option>'+db_kids.map(k=>`<option>${k}</option>`).join("");
selBook.innerHTML='<option value="">Libro</option>'+db_books.filter(b=>!b.loaned).map(b=>`<option value="${b.id}">${b.title}</option>`).join("");

listRes.innerHTML=db_books.filter(b=>b.loaned).map(b=>`
<div class="list-item">
<div class="info"><h4>${b.title}</h4><p>${b.kid} (${b.date})</p></div>
<button class="btn-res" onclick="executeReturn('${b.id}')">RESO</button>
</div>`).join("")||"<p>Nessun libro fuori</p>";

listCat.innerHTML=db_books.filter(b=>b.title.toLowerCase().includes(searchCat.value.toLowerCase())).map(b=>`
<div class="list-item">
<div class="info"><h4>${b.title}</h4><p>${b.author}</p></div>
<span class="badge ${b.loaned?'bg-out':'bg-ok'}">${b.loaned?'Fuori':'Libero'}</span>
</div>`).join("");

kidsDisplay.innerHTML=db_kids.map(k=>`
<span class="tag">${k}
<button onclick="deleteKid('${k}')" style="border:none;background:none;color:#e53e3e;cursor:pointer">âœ•</button>
</span>`).join("");
}

refreshUI();
</script>
</body>
</html>
